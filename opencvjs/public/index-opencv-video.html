<!DOCTYPE html>
<html>
  <head>
    <title>opencv.js sandbox</title>
    <meta charset="UTF-8" />
    <style>
        .modal {
            display: none; /* Hidden by default */
            position: fixed; /* Stay in place */
            z-index: 1; /* Sit on top */
            padding-top: 100px; /* Location of the box */
            left: 0;
            top: 0;
            width: 100%; /* Full width */
            height: 100%; /* Full height */
            overflow: auto; /* Enable scroll if needed */
            background-color: rgb(0,0,0); /* Fallback color */
            background-color: rgba(0,0,0,0.9); /* Black w/ opacity */
        }

        .modal-content {
            margin: auto;
            display: block;
            width: 100%;
        }

        .close {
            position: absolute;
            top: 15px;
            right: 35px;
            color: #f1f1f1;
            font-size: 40px;
            font-weight: bold;
            transition: 0.3s;
        }

        .close:hover,
        .close:focus {
            color: #bbb;
            text-decoration: none;
            cursor: pointer;
        }

        video {
            position: absolute;
            left: 0;
            top: 0;
            background: rgba(241, 26, 73, 0.89);
        }

        .canvas-scan {
            position: absolute;
            top: 0;
            left: 0;
            z-index: 10;
        }

        .canvas-detect {
            position: absolute;
            top:0;
        }

        .canvas-threshold {
            position: relative;
            top: 800px;
            left: 0px;
        }

        .canvas-dev {
            position: absolute;
            top: 800px;
            left: 0px;
        }
    </style>
  </head>

  <body>
    <div>
        <video id="videoInput"></video> 
        <div id="debugdiv" style="position:fixed"></div>
        <canvas id="canvasScan" class="canvas-scan"></canvas>
        <canvas id="canvasThreshold" class="canvas-dev"></canvas>
        <canvas id="canvasOutput" style="margin:auto; display:block;"></canvas>
        <canvas id="canvasDetect" class="canvas-detect"></canvas>
        <canvas id="canvasDetectThreshold" class="canvas-dev"></canvas>
    </div>
    
    <button type="button" onclick="takePicture()">Take picture</button>

    <div id="myModal" class="modal">
        <span class="close">&times;</span>
        <canvas id="canvasCropped" class="modal-content"></canvas>
    </div>

    <script async src="../src/opencv.js" type="text/javascript"></script>
    <script>
        let _video_width = 0;
        let _video_height = 0;
        let video = document.getElementById("videoInput");

        navigator.mediaDevices.getUserMedia({   
            audio: false,
            video: { 
                facingMode:"environment",
                width: { min: 1280, ideal: 1920, max: 2560 },
                height: { min: 720, ideal: 1080, max: 1440 }, 
            }
        })
        .then(function (stream) {
            video.srcObject = stream;
            video.play();
        })
        .catch(function(err) {
            console.log("An error occurred! " + err);
        });

        video.onplaying = function () {
            _video_width = video.videoWidth;
            _video_height = video.videoHeight;

            console.log("video dimens loaded w="+_video_width+" h="+_video_height);

            var debugdiv = document.getElementById("debugdiv");
            debugdiv.style.top = _video_height + 20 + "px";
            debugdiv.innerHTML = _video_width + " x " + _video_height;

            var canvas_scan = document.getElementById("canvasScan");
            canvas_scan.width = _video_width;
            canvas_scan.height = _video_height;
            let canvas_scan_src = new cv.Mat(canvas_scan.height, canvas_scan.width, cv.CV_8UC4);

            let canvas_detect = document.getElementById("canvasDetect");
            canvas_detect.width = _video_width;
            canvas_detect.height = _video_height;
            
            let canvas_detect_threshold = document.getElementById("canvasDetectThreshold"); 
            canvas_detect_threshold.width = _video_width;
            canvas_detect_threshold.height = _video_height;

            //Selecciona el lado menor
            let orientation = _video_width < _video_height ? "portrait" : "landscape";
            let detect_w = _video_width*0.8;
            let detect_h = detect_w/1.5;
            let tl_corner_x = _video_width*0.1;
            let tl_corner_y = (_video_height-detect_h)/2;
            let tl_corner = new cv.Point(tl_corner_x, tl_corner_y);
            let br_corner = new cv.Point(tl_corner_x+detect_w, tl_corner_y+detect_h);
            cv.rectangle(canvas_scan_src, tl_corner, br_corner, new cv.Scalar(0,255,0,255), 2, cv.LINE_AA, 0);

            cv.imshow("canvasScan", canvas_scan_src);

            video.height = _video_height;
            video.width = _video_width;
            let cap = new cv.VideoCapture(video);
            let src = new cv.Mat(_video_height, _video_width, cv.CV_8UC4);
            let dst = new cv.Mat(_video_height, _video_width, cv.CV_8UC1);
            
            const FPS = 30;
            function processVideo() {
                let canvas_detect_src = new cv.Mat.zeros(canvas_detect.height, canvas_detect.width, cv.CV_8UC4);
                let src_clone = src.clone();
                let src_user = src.clone();
                let begin = Date.now();
                // Lee imagen del video capturado "cap" y la copia en "src"
                cap.read(src);
                
                let ksize = new cv.Size(3, 3);
                cv.GaussianBlur(src_clone, src_clone, ksize, 0, 0, cv.BORDER_DEFAULT);
                //let dst_gray = new cv.Mat(height, width, cv.CV_8UC4);
                let dst_gray = new cv.Mat(_video_height, _video_width, cv.CV_8UC4);
                cv.cvtColor(src_clone, dst_gray, cv.COLOR_BGR2GRAY, 0);

                //let dst_thresh = new cv.Mat(height, width, cv.CV_8UC4);
                let dst_thresh = new cv.Mat(_video_height, _video_width, cv.CV_8UC4);

                /* Use cv.ADAPTIVE_THRESH_GAUSSIAN_C or cv.ADAPTIVE_THRESH_MEAN_C */
                //cv.adaptiveThreshold(dst_gray, dst_thresh, 255, cv.ADAPTIVE_THRESH_MEAN_C, cv.THRESH_BINARY_INV, 7, 2);
                
                /* Color range filter */
                /*
                cv.inRange(dst_gray, 
                    new cv.Mat(dst_gray.rows, dst_gray.cols, dst_gray.type(), [100, 100, 100, 0]), 
                    new cv.Mat(dst_gray.rows, dst_gray.cols, dst_gray.type(), [255, 250, 250, 255]),  
                    dst_thresh);
                cv.imshow("canvasFilter", dst_thresh);
                */

                cv.threshold(dst_gray, dst_thresh, 100, 255, cv.THRESH_BINARY);
                cv.imshow("canvasThreshold", dst_thresh);

                /* Dilate */
                //let M = cv.Mat.ones(5, 5, cv.CV_8U);
                //let anchor = new cv.Point(-1, -1);
                //cv.dilate(dst_thresh, dst_thresh, M, anchor, 1, cv.BORDER_CONSTANT, cv.morphologyDefaultBorderValue());

                /* Contours */
                let dst_cont = cv.Mat.zeros(src.rows, src.cols, cv.CV_8UC3);
                let contours = new cv.MatVector();
                let hierarchy = new cv.Mat();
                cv.findContours(dst_thresh, contours, hierarchy, cv.RETR_CCOMP, cv.CHAIN_APPROX_SIMPLE);
                let color = new cv.Scalar(255,0,0);
                let max_per = 0;
                let max_per_i = 0;
                let max_area = 0;
                let max_area_i = 0;
                if (contours.size() > 0){
                    for (let i = 0; i < contours.size(); ++i) {
                        area = cv.contourArea(contours.get(i), false);
                        if (area > 3){
                            //cv.drawContours(dst_cont, contours, i, color, 1, cv.LINE_8, hierarchy, 100);
                            // Get the maximum area contour 
                            if (area > max_area){
                                max_area = area;
                                max_area_i = i;
                            }
                        }
                    }

                    let max_area_contour = contours.get(max_area_i);
                    let max_area_bb = cv.boundingRect(max_area_contour);
                    let max_area_bb_p1 = new cv.Point(max_area_bb.x, max_area_bb.y);
                    let max_area_bb_p2 = new cv.Point(max_area_bb.x + max_area_bb.width, max_area_bb.y + max_area_bb.height);
                    cv.rectangle(canvas_detect_src, max_area_bb_p1, max_area_bb_p2, new cv.Scalar(0,0,255,255), 2, cv.LINE_AA, 0);
                    cv.rectangle(canvas_detect_src, max_area_bb_p1, max_area_bb_p2, new cv.Scalar(106,132,189,100), -1, cv.LINE_AA, 0);

                    if(max_area_bb.x > 150){
                        if (max_area_bb.y > 50 && 520 < max_area_bb.width && max_area_bb.width < 540){
                            takePicture();
                        }
                    }
                }

                cv.imshow("canvasDetect", canvas_detect_src);
                cv.imshow("canvasDetectThreshold", canvas_detect_src);
                
                src_clone.delete(); 
                canvas_detect_src.delete(); 
                src_user.delete();
                dst_gray.delete(); 
                dst_thresh.delete(); 
                dst_cont.delete();
                contours.delete(); 
                hierarchy.delete();

                let delay = 1000/FPS - (Date.now() - begin);
                setTimeout(processVideo, delay);
            }
            setTimeout(processVideo, 0);
        }

        function takePicture(){
            var modal = document.getElementById("myModal");
            var modalCanvas = document.getElementById("canvasCropped");
            modal.style.display = "block";

            let src_to_crop = cv.imread('canvasOutput');
            let rectangle = new cv.Rect(150, 50, 560, 380); //rect = new cv.Rect(x, y, width, height);
            let cropped_image = src_to_crop.roi(rectangle);
            cv.imshow("canvasCropped", cropped_image);
            var close = document.getElementsByClassName("close")[0];

            close.onclick = function() { 
                modal.style.display = "none";
            }
        }
    </script>
    
  </body>
</html>